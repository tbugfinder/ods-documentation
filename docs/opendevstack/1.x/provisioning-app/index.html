<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Overview: Provisioning Application :: OpenDevStack</title>
    <link rel="canonical" href="https://www.opendevstack.org/ods-documentation/opendevstack/3.x/provisioning-app/index.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.opendevstack.org/ods-documentation">OpenDevStack</a>
        <div class="navbar-item">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="opendevstack" data-version="1.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../getting-started/index.html">OpenDevStack</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../jenkins-shared-library/index.html">Jenkins Shared Library</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quickstarters/index.html">Quickstarters</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-docker-plain.html">BE Docker Plain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-golang.html">BE Golang</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-java-springboot.html">BE Java / Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-node-express.html">BE Node Express</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-python-flask.html">BE Python Flask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-scala-akka.html">BE Scala Akka</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-angular.html">FE Angular</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-ionic.html">FE Ionic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-react.html">FE React</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-vue.html">FE Vue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-ml-service.html">Data Science Machine Learning Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-jupyter-notebook.html">Data Science Jupyter Notebook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-rshiny-app.html">Data Science RShiny app</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/airflow.html">Airflow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/e2e-cypress.html">Cypress E2E testing Quickstarters</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Provisioning App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="architecture.html">Internal Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="faq.html">FAQ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrade_notes.html">Upgrade Notes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../local-installation.html">Local Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sysenv-requirements.html">System and Environment Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../infrastructure-setup.html">Infrastructure Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../jenkins/index.html">Jenkins</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins/webhook-proxy.html">Webhook Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins/slave-base.html">Jenkins Slave Base Image</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Shared Images</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../shared-images/openresty-nginx.html">OpenResty Base image + WAF</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../shared-images/nginx-authproxy-crowd.html">Crowd Authproxy</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../sonarqube/index.html">SonarQube</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenDevStack</span>
    <span class="version">1.x</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenDevStack</span>
      <ul class="versions">
        <li class="version">
          <a href="../../4.x/getting-started/index.html">4.x Preview</a>
        </li>
        <li class="version is-latest">
          <a href="../../3.x/getting-started/index.html">3.x</a>
        </li>
        <li class="version">
          <a href="../../2.x/getting-started/index.html">2.x</a>
        </li>
        <li class="version is-current">
          <a href="../getting-started/index.html">1.x</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../3.x/getting-started/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../getting-started/index.html">OpenDevStack</a></li>
    <li><a href="index.html">Provisioning App</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">1.x</button>
  <div class="version-menu">
    <a class="version" href="../../4.x/provisioning-app/index.html">4.x Preview</a>
    <a class="version" href="../../3.x/provisioning-app/index.html">3.x</a>
    <a class="version" href="../../2.x/provisioning-app/index.html">2.x</a>
    <a class="version is-current" href="index.html">1.x</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/opendevstack/ods-provisioning-app/edit/1.2.x/docs/modules/provisioning-app/pages/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Overview: Provisioning Application</h1>
<div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_basic_idea_usage">Basic idea &amp; usage</a></li>
<li><a href="#_integration_with_bitbucket_webhooks">Integration with Bitbucket (webhooks)</a></li>
<li><a href="#_permissions">Permissions</a></li>
<li><a href="#_projectspace_types_based_on_templates">Project/Space types based on templates</a></li>
<li><a href="#_using_the_provision_application_via_api_thru_direct_rest_calls">Using the provision application via API / thru direct REST calls</a></li>
<li><a href="#_what_happens_in_error_cases">What happens in error cases</a></li>
</ul>
</div>
<div class="paragraph">
<p>This application creates new OpenDevStack digital projects. It is the central entrypoint to get started with a new project / or provision new components based on <a href="https://github.com/opendevstack/ods-project-quickstarters">quickstarters</a>.
It delegates the tasks to create / update resources to several services such as jira, confluence, bitbucket and rundeck.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_idea_usage"><a class="anchor" href="#_basic_idea_usage"></a>Basic idea &amp; usage</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An admin (user in a group defined in property <code>idmanager.group.opendevstack-administrators</code>) creates new ODS project. This in turn creates</p>
<div class="ulist">
<ul>
<li>
<p>a Jira Project (name based on project <code>key</code> &amp; <code>name</code>)</p>
</li>
<li>
<p>a Confluence Space (name based on project&#8217;s <code>key</code>)</p>
</li>
<li>
<p>the required Openshift projects named <code>key</code>-dev, <code>key</code>-test and <code>key</code>-cd - in case <code>openshiftproject == true</code>. Internally this is done thru a rest call to rundeck triggering the <a href="https://github.com/opendevstack/ods-project-quickstarters/blob/master/rundeck-jobs/openshift/create-projects.yaml">create-projects rundeck job</a></p>
</li>
<li>
<p>a Bitbucket Project (name based on project <code>key</code>) - in case <code>openshiftproject == true</code>. Within this project two default repositories are created <code>key</code>-oc-config-artifacts for all <code>yaml</code> resources as well as <code>key</code>-design for any design artifacts (e.g. sketches)</p>
</li>
</ul>
</div>
</li>
<li>
<p>A normal user (user in a group defined in property <code>idmanager.group.opendevstack-users</code>) creates all resources required for a working component -
this happens thru the user interface - in going to modify project / picking your project and then the wanted quickstarter. Internally this is done thru a rest call to rundeck - with the picked job as parameter - <a href="https://github.com/opendevstack/ods-project-quickstarters/tree/master/rundeck-jobs/quickstarts">here</a></p>
<div class="ulist">
<ul>
<li>
<p>Bitbucket repository within the chosen project named <code>key</code>-<code>boilerplate name</code></p>
</li>
<li>
<p>Openshift components based on the chosen boilerplate, coming from <a href="https://github.com/opendevstack/ods-project-quickstarters">ods-quickstarters</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>The involved people receive an email with the setup, URLs to components etc. - in case <code>mail.enabled == true</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integration_with_bitbucket_webhooks"><a class="anchor" href="#_integration_with_bitbucket_webhooks"></a>Integration with Bitbucket (webhooks)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next to the provision app creating the bitbucket repository for a chosen quickstarter - it also creates a webhook on that repo, which triggers on three events</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    List&lt;String&gt; events = new ArrayList&lt;String&gt;();
        events.add("repo:refs_changed");
        events.add("pr:merged");
        events.add("pr:declined");
    webhook.setEvents(events);</pre>
</div>
</div>
<div class="paragraph">
<p>This webhook calls the <a href="https://github.com/opendevstack/ods-core/tree/master/jenkins/webhook-proxy">webhook proxy</a> which in turn creates an openshift <code>build config</code> of type <code>pipeline</code> in the <code>name</code>-cd project and executes it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_permissions"><a class="anchor" href="#_permissions"></a>Permissions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default no special permissions are set on either confluence / jira / bitbucket or openshift, only system-wide settings are inherited.</p>
</div>
<div class="paragraph">
<p>However there is a special knob to tighten security (which can be passed with the project input <code>createpermissionset : boolean</code>)  - based on three groups that need to be provided as part of the API call / from the userinterface.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>admin group: admin rights on the generated projects / spaces / repositories</p>
</li>
<li>
<p>user group: read / write rights on the generated projects / spaces / repositories</p>
</li>
<li>
<p>readonly group: read rights on the generated projects / spaces / repositories</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The configuration for the permission sets are configured:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>JIRA Project is provisioned with its own permissionset defined in <a href="https://github.com/opendevstack/ods-provisioning-app/blob/master/src/main/resources/permission-templates/jira.permission.all.txt">src/main/resources/permission-templates/jira.permission.all.txt</a></p>
</li>
<li>
<p>Confluence Project is provisioned with special permission set defined in <a href="https://github.com/opendevstack/ods-provisioning-app/blob/master/src/main/resources/permission-templates">src/main/resources/permission-templates/confluence.permission.*</a></p>
</li>
<li>
<p>Bitbucket Project is provisioned with tight read &amp; write roles</p>
</li>
<li>
<p>Openshift Project roles linked to the passed groups (<code>READONLY</code> - <code>view</code>, <code>ADMINGROUP</code> - <code>admin</code>, <code>USERS</code> - <code>edit</code>)</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_projectspace_types_based_on_templates"><a class="anchor" href="#_projectspace_types_based_on_templates"></a>Project/Space types based on templates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The default jira / confluence project' types are defined in <a href="https://github.com/opendevstack/ods-provisioning-app/blob/master/src/main/resources/application.properties">src/main/resources/application.properties</a> - and correspondingly in the config maps</p>
</div>
<div class="listingblock">
<div class="content">
<pre>project.template.key.names=default

jira.project.template.key=com.pyxis.greenhopper.jira:gh-scrum-template
jira.project.template.type=software

confluence.blueprint.key=com.atlassian.confluence.plugins.confluence-software-project:sp-space-blueprint</pre>
</div>
</div>
<div class="paragraph">
<p>To add a new template - copy, and add your config, based on a new <code>&lt;name&gt;</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>jira.project.template.key.&lt;name&gt;=com.pyxis.greenhopper.jira:gh-scrum-template
jira.project.template.type.&lt;name&gt;=software

# optional, can stay as is
confluence.blueprint.key.&lt;name&gt;=com.atlassian.confluence.plugins.confluence-software-project:sp-space-blueprint</pre>
</div>
</div>
<div class="paragraph">
<p>and add the new <name>from above to the existing property <code>project.template.key.names</code></name></p>
</div>
<div class="listingblock">
<div class="content">
<pre># list of templates surfaced to the UI and API
project.template.key.names=default,&lt;name&gt;</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_the_provision_application_via_api_thru_direct_rest_calls"><a class="anchor" href="#_using_the_provision_application_via_api_thru_direct_rest_calls"></a>Using the provision application via API / thru direct REST calls</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">PROVISION_API_HOST=&lt;host name&gt;

curl -D headers.txt -k -H "Content-Type: application/x-www-form-urlencoded" \
-X POST ${PROVISION_API_HOST}/j_security_check \
-d username=&lt;username&gt; -d password=&lt;password&gt;

# grab the login status, and exit if error
login_status=$(cat headers.txt | grep ${PROVISION_API_HOST}/login?error)

if [[ $login_status != "" ]]; then echo "Login Error"; exit 1; fi;

# grab the needed IDs and bake the cookies
JSESSION_ID=$(cat headers.txt | grep "Set-Cookie: JSESSION" | cut -d ';' -f1 | cut -d ":" -f2)";"
CROWD_COOKIE=$(cat headers.txt | grep "Set-Cookie: crowd" | cut -d ';' -f1 | cut -d ":" -f2)

COOKIES=${JSESSION_ID}${CROWD_COOKIE}

# sample provision file &gt;&gt; create.txt
{
  "name" : "&lt;Mandatory name&gt;",
  "key" : "&lt;Mandatory key&gt;",
  "createpermissionset" : true,
  "jiraconfluencespace" : true,
  "admin" : "&lt;admin user&gt;",
  "adminGroup" : "&lt;admin group&gt;",
  "userGroup" : "&lt;user group&gt;",
  "readonlyGroup" : "&lt;readonly group&gt;",
  "openshiftproject" : false
}

provisionfile=create.txt

# invoke the provision API to create a new project
curl -k -X POST --cookie "$COOKIES" -d @"$provisionfile" \
-H "Content-Type: application/json; charset=utf-8" -v ${PROVISION_API_HOST}/api/v2/project</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_happens_in_error_cases"><a class="anchor" href="#_what_happens_in_error_cases"></a>What happens in error cases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Up to (and including) <em>v1.1.x</em> when provisioning failed, corrupt and inconsistent states where left in the bugtracker system, bitbucket etc. which had do be cleaned up <em>manually</em> based on logs. This is rectified and a the new <code>default</code> behavior is to see every post to the API as <code>atomic</code> unit of work, which in case of failure is tried to be cleaned up (alike functional rollback). This behavior can be turned <em>off</em> by specifying the new property
<em>provision.cleanup.incomplete.projects</em> and setting it to <em>false</em>.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.1.1/tocbot.min.js"></script>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/search.js" id="search-script" data-base-path="../../.." data-page-path="/opendevstack/1.x/provisioning-app/index.html"></script>
<script async src="../../../_/../search-index.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script>
  tocbot.init( {
                  tocSelector: '#article-toc',
                  contentSelector: 'article',
                  headingSelector: 'h2, h3, h4, h5, h6',
                  collapseDepth: 6,
                  positionFixedSelector: '#article-toc',
                  scrollSmooth: false
                } );
  var tocList = document.getElementById( 'article-toc' ).getElementsByClassName( 'toc-list' );
  if ( tocList && tocList.length > 0 && tocList[0].childNodes.length > 0 ) {
    document.getElementById( 'article-toc' ).parentNode.classList.remove( 'hidden' );
  }
</script>
  </body>
</html>
