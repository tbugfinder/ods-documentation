<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins Shared Library :: OpenDevStack</title>
    <link rel="canonical" href="https://www.opendevstack.org/ods-documentation/opendevstack/3.x/jenkins-shared-library/index.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.opendevstack.org/ods-documentation">OpenDevStack</a>
        <div class="navbar-item">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="opendevstack" data-version="1.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../getting-started/index.html">OpenDevStack</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="index.html">Jenkins Shared Library</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quickstarters/index.html">Quickstarters</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-docker-plain.html">BE Docker Plain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-golang.html">BE Golang</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-java-springboot.html">BE Java / Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-node-express.html">BE Node Express</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-python-flask.html">BE Python Flask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-scala-akka.html">BE Scala Akka</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-angular.html">FE Angular</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-ionic.html">FE Ionic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-react.html">FE React</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-vue.html">FE Vue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-ml-service.html">Data Science Machine Learning Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-jupyter-notebook.html">Data Science Jupyter Notebook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-rshiny-app.html">Data Science RShiny app</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/airflow.html">Airflow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/e2e-cypress.html">Cypress E2E testing Quickstarters</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../provisioning-app/index.html">Provisioning App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/configuration.html">Configuration Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/architecture.html">Internal Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/faq.html">FAQ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/upgrade_notes.html">Upgrade Notes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../local-installation.html">Local Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sysenv-requirements.html">System and Environment Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../infrastructure-setup.html">Infrastructure Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../jenkins/index.html">Jenkins</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins/webhook-proxy.html">Webhook Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins/slave-base.html">Jenkins Slave Base Image</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Shared Images</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../shared-images/openresty-nginx.html">OpenResty Base image + WAF</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../shared-images/nginx-authproxy-crowd.html">Crowd Authproxy</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../sonarqube/index.html">SonarQube</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenDevStack</span>
    <span class="version">1.x</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenDevStack</span>
      <ul class="versions">
        <li class="version">
          <a href="../../4.x/getting-started/index.html">4.x Preview</a>
        </li>
        <li class="version is-latest">
          <a href="../../3.x/getting-started/index.html">3.x</a>
        </li>
        <li class="version">
          <a href="../../2.x/getting-started/index.html">2.x</a>
        </li>
        <li class="version is-current">
          <a href="../getting-started/index.html">1.x</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../3.x/getting-started/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../getting-started/index.html">OpenDevStack</a></li>
    <li><a href="index.html">Jenkins Shared Library</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">1.x</button>
  <div class="version-menu">
    <a class="version" href="../../4.x/jenkins-shared-library/index.html">4.x Preview</a>
    <a class="version" href="../../3.x/jenkins-shared-library/index.html">3.x</a>
    <a class="version" href="../../2.x/jenkins-shared-library/index.html">2.x</a>
    <a class="version is-current" href="index.html">1.x</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/opendevstack/ods-jenkins-shared-library/edit/1.2.x/docs/modules/jenkins-shared-library/pages/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Jenkins Shared Library</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This library allows to have a minimal Jenkinsfile in each repository by providing all language-agnostic build aspects. The goal is to duplicate as little as possible between repositories and have an easy way to ship updates to all projects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage"><a class="anchor" href="#_usage"></a>Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Load the shared library in your <code>Jenkinsfile</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">def final projectId = "hugo"
def final componentId = "be-node-express"
def final credentialsId = "${projectId}-cd-cd-user-with-password"
def sharedLibraryRepository
def dockerRegistry
node {
  sharedLibraryRepository = env.SHARED_LIBRARY_REPOSITORY
  dockerRegistry = env.DOCKER_REGISTRY
}

library identifier: 'ods-library@production', retriever: modernSCM(
  [$class: 'GitSCMSource',
   remote: sharedLibraryRepository,
   credentialsId: credentialsId])

odsPipeline(
  image: "${dockerRegistry}/cd/jenkins-slave-maven",
  projectId: projectId,
  componentId: componentId,
  branchToEnvironmentMapping: [
    'master': 'test',
    '*': 'dev'
  ]
) { context -&gt;
  stage('Build') {
      // custom stage
  }
  stageScanForSonarqube(context) // using a provided stage
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_provided_stages"><a class="anchor" href="#_provided_stages"></a>Provided Stages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Following stages are provided (see folder vars for more details):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_stage_scan_for_sonarqube">stageScanForSonarqube(context)</a></p>
</li>
<li>
<p>stageOWASPDependencyCheck(context)</p>
</li>
<li>
<p><a href="#_stage_scan_for_snyk">stageScanForSnyk(context, snykAuthenticationCode, buildFile, projectId)</a></p>
</li>
<li>
<p>stageUploadToNexus(context)</p>
</li>
<li>
<p><a href="#_stage_start_openshift_build">stageStartOpenshiftBuild(context)</a></p>
</li>
<li>
<p>stageDeployToOpenshift(context)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_workflow"><a class="anchor" href="#_workflow"></a>Workflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The shared library does not impose which Git workflow you use. Whether you use git-flow, GitHub flow or a custom workflow, it is possible to configure the shared library according to your needs. There are just two settings to control everything: <code>branchToEnvironmentMapping</code> and <code>autoCloneEnvironmentsFromSourceMapping</code>.</p>
</div>
<div class="sect2">
<h3 id="_branchtoenvironmentmapping"><a class="anchor" href="#_branchtoenvironmentmapping"></a>branchToEnvironmentMapping</h3>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>branchToEnvironmentMapping: [
  "master": "prod",
  "develop": "dev",
  "hotfix/": "hotfix",
  "*": "review"
]</pre>
</div>
</div>
<div class="paragraph">
<p>Maps a branch to an environment. There are three ways to reference branches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fixed name (e.g. <code>master</code>)</p>
</li>
<li>
<p>Prefix (ending with a slash, e.g. <code>hotfix/</code>)</p>
</li>
<li>
<p>Any branch (<code>*</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Matches are made top-to-bottom. For prefixes / any branch, a more specific environment might be selected if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the branch contains a ticket ID and a corresponding env exists in OCP. E.g. for mapping <code>"feature/": "dev"</code> and branch <code>feature/foo-123-bar</code>, the env <code>dev-123</code> is selected instead of <code>dev</code> if it exists.</p>
</li>
<li>
<p>the branch name corresponds to an existing env in OCP. E.g. for mapping <code>"release/": "rel"</code> and branch <code>release/1.0.0</code>, the env <code>rel-1.0.0</code> is selected instead of <code>rel</code> if it exists.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_autocloneenvironmentsfromsourcemapping"><a class="anchor" href="#_autocloneenvironmentsfromsourcemapping"></a>autoCloneEnvironmentsFromSourceMapping</h3>
<div class="paragraph">
<p>Caution! Cloning environments on-the-fly is an advanced feature and should only be used if you understand OCP well, as there are many moving parts and things can go wrong in multiple places.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>autoCloneEnvironmentsFromSourceMapping: [
  "hotfix": "prod",
  "review": "dev"
]</pre>
</div>
</div>
<div class="paragraph">
<p>Instead of deploying multiple branches to the same environment, individual environments can be created on-the-fly. For example, the mapping <code>"*": "review"</code> deploys all branches to the <code>review</code> environment. To have one environment per branch / ticket ID, you can add the <code>review</code> environment to <code>autoCloneEnvironmentsFromSourceMapping</code>, e.g. like this: <code>"review": "dev"</code>. This will create individual environments (named e.g. <code>review-123</code> or <code>review-foobar</code>), each cloned from the <code>dev</code> environment.</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples"><a class="anchor" href="#_examples"></a>Examples</h3>
<div class="paragraph">
<p>If you use <a href="https://jeffkreeftmeijer.com/git-flow/">git-flow</a>, the following config fits well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>branchToEnvironmentMapping: [
  'master': 'prod',
  'develop': 'dev',
  'release/': 'rel',
  'hotfix/': 'hotfix',
  '*': 'preview'
]
// Optionally, configure environments on-the-fly:
autoCloneEnvironmentsFromSourceMapping: [
  'rel': 'dev',
  'hotfix': 'prod',
  'preview': 'dev'
]</pre>
</div>
</div>
<div class="paragraph">
<p>If you use <a href="https://guides.github.com/introduction/flow/">GitHub Flow</a>, the following config fits well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>branchToEnvironmentMapping: [
  'master': 'prod',
  '*': 'preview'
]
// Optionally, configure environments on-the-fly:
autoCloneEnvironmentsFromSourceMapping: [
  'preview': 'prod'
]</pre>
</div>
</div>
<div class="paragraph">
<p>If you use a custom workflow, the config could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>branchToEnvironmentMapping: [
  'production': 'prod',
  'master': 'dev',
  'staging': 'uat'
]
// Optionally, configure environments on-the-fly:
autoCloneEnvironmentsFromSourceMapping: [
  'uat': 'prod'
]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_stages"><a class="anchor" href="#_writing_stages"></a>Writing stages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Inside the closure passed to <code>odsPipeline</code>, you have full control. Write stages just like you would do in a normal <code>Jenkinsfile</code>. You have access to the <code>context</code>, which is assembled for you on the master node. The <code>context</code> can be influenced by changing the config map passed to <code>odsPipeline</code>. Please see <code>vars/odsPipeline.groovy</code> for possible options.</p>
</div>
<div class="paragraph">
<p>When you write stages, you have access to both global variables (defined without <code>def</code> in the <code>Jenkinsfile</code>) and the
<code>context</code> object. It contains the following properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value of JOB_NAME. It is the name of the project of the build.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">buildNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value of BUILD_NUMBER. The current build number, such as "153".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">buildUrl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value of BUILD_URL. The URL where the results of the build can be found (e.g. <a href="http://buildserver/jenkins/job/MyJobName/123/" class="bare">http://buildserver/jenkins/job/MyJobName/123/</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">buildTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time of the build, collected when the odsPipeline starts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Container image to use for the Jenkins agent container. This value is not used when "podContainers" is set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">podLabel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pod label, set by default to a random label to avoid caching issues. Set to a stable label if you want to reuse pods across builds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">podContainers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom pod containers to use. By default, only one container is used, and it is configure automatically. If you need to run multiple containers (e.g. app and database), then you can configure the containers via this property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">podVolumes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Volumes to make available to the pod.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">podAlwaysPullImage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determine whether to always pull the container image before each build run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">podServiceAccount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serviceaccount to use when running the pod.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">credentialsId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credentials identifier (Credentials are created and named automatically by the OpenShift Jenkins plugin).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tagversion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The tagversion is made up of the build number and the first 8 chars of the commit SHA.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notifyNotGreen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to send notifications if the build is not successful.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nexusHost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nexus host (with scheme).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nexusUsername</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nexus username.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nexusPassword</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nexus password.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nexusHostWithBasicAuth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nexus host (with scheme), including username and password as BasicAuth.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchToEnvironmentMapping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define which branches are deployed to which environments.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoCloneEnvironmentsFromSourceMapping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define which environments are cloned from which source environments.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cloneSourceEnv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The environment which was chosen as the clone source.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">environment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The environment which was chosen as the deployment target, e.g. "dev".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">targetProject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Target project, based on the environment. E.g. "foo-dev".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group ID, defaults to: org.opendevstack.<projectID>.</projectID></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">projectId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Project ID, e.g. "foo".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">componentId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Component ID, e.g. "be-auth-service".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gitUrl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Git URL of repository</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gitBranch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Git branch for which the build runs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gitCommit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Git commit SHA to build.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gitCommitAuthor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Git commit author.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gitCommitMessage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Git commit message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gitCommitTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Git commit time in RFC 3399.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sonarQubeBranch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Branch on which to run SonarQube analysis.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">failOnSnykScanVulnerabilities</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean flag (default true) that disables build failure in case Snyk Scan finds vulnerabilities</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dependencyCheckBranch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Branch on which to run dependency checks.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">environmentLimit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of environments to allow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">openshiftHost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenShift host - value taken from OPENSHIFT_API_URL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">odsSharedLibVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ODS Jenkins shared library version, taken from reference in Jenkinsfile.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bitbucketHost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BitBucket host - value taken from BITBUCKET_HOST.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">environmentCreated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an environment has been created during the build.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">openshiftBuildTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout for the OpenShift build of the container image.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ciSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the build should be skipped, based on the Git commit message.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_slave_customization"><a class="anchor" href="#_slave_customization"></a>Slave customization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The slave used to build your code can be customized by specifying the image to
use. Further, <code>podAlwaysPullImage</code> (defaulting to <code>true</code>) can be used to
determine whether this image should be refreshed on each build. The setting
<code>podVolumes</code> allows to mount persistent volume claims to the pod (the value is
passed to the <code>podTemplate</code> call as <code>volumes</code>). To control the container pods
completely, set <code>podContainers</code> (which is passed to the <code>podTemplate</code> call
as <code>containers</code>). See the
<a href="https://github.com/jenkinsci/kubernetes-plugin">kubernetes-plugin</a>
documentation for possible configuration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_versioning"><a class="anchor" href="#_versioning"></a>Versioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each <code>Jenkinsfile</code> references a Git revsison of this library, e.g.
<code>library identifier: 'ods-library@production'</code>. The Git revsison can be a
branch (e.g. <code>production</code> or <code>0.1.x</code>), a tag (e.g.<code>0.1.1</code>) or a specific commit.</p>
</div>
<div class="paragraph">
<p>By default, each <code>Jenkinsfile</code> in <code>ods-project-quickstarters</code> on the <code>master</code>
branch references the <code>production</code> branch of this library. Quickstarters on a
branch point to the corresponding branch of the shared library - for example
a <code>Jenkinsfile</code> on branch <code>0.1.x</code> points to <code>0.1.x</code> of the shared library.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_lfs_git_large_file_storage_extension"><a class="anchor" href="#_git_lfs_git_large_file_storage_extension"></a>Git LFS (Git Large File Storage extension)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are working with large files (e.g.: binary files, media files, files bigger than 5MB&#8230;&#8203;),
you can follow the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check this HOWTO about <a href="https://www.atlassian.com/git/tutorials/git-lfs">Git LFS</a></p>
</li>
<li>
<p>Track your large files in your local clone, as explained in previous step</p>
</li>
<li>
<p>Enable Git LFS in your repository (if BitBucket: under repository&#8217;s settings main page you can enable it)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>NOTE</strong>: if already having a repository with large files and you want to migrate it to using git LFS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git lfs migrate</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_add_snyk_scanning_to_your_ods_project"><a class="anchor" href="#_how_to_add_snyk_scanning_to_your_ods_project"></a>How to add Snyk scanning to your ODS project</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setup organisation in snyk.io</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you don´t have an snyk account just create one at snyk.io</p>
</li>
<li>
<p>Once you logged into snyk.io, in your snyk group create an organisation for your project with exactly same name as project name.</p>
</li>
<li>
<p>Create a service account in settings for the created organisation and keep the displayed token. You will need it later.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Add environment variable to jenkins in your cd project</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the environment variable <code>SNYK_AUTHENTICATION_CODE</code> in jenkins in your openshift cd project with service account token as value.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Edit your project Jenkinsfile</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Read auth code from environment by adding:</p>
<div class="listingblock">
<div class="content">
<pre> node {
     ...
   snykAuthenticationCode = env.SNYK_AUTHENTICATION_CODE
}</pre>
</div>
</div>
</li>
<li>
<p>Add stageScanForSnyk:</p>
<div class="listingblock">
<div class="content">
<pre> ) { context -&gt;
    ...

   stageScanForSnyk(context, snykAuthenticationCode, 'build.gradle', context.projectId)
   ...
 }</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stages"><a class="anchor" href="#_stages"></a>Stages</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ods_pipeline"><a class="anchor" href="#_ods_pipeline"></a>Ods Pipeline</h3>
<div class="paragraph">
<p>The odsPipeline method offers a complete pipeline for any component created with a quickstarter. It takes care of building the code, uploading artifacts to Nexus, analysing the code and starting builds and triggering deployments in Openshift.</p>
</div>
</div>
<div class="sect2">
<h3 id="_stage_scan_for_snyk"><a class="anchor" href="#_stage_scan_for_snyk"></a>Stage Scan for Snyk</h3>
<div class="paragraph">
<p>The "Snyk Security Scan" stage does 2 tasks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>uploads the list of project 3rd party dependencies including its licenses for monitoring. Snyk monitoring feature notifies developers about new vulnerabilities per email once this vulnerabilities are reported to the Snyk Vulnerability Database</p>
</li>
<li>
<p>analyses your project 3rd party dependencies including its licenses and break the build if vulnerable versions are found in the project. Build fail can be disable with the property <code>failOnSnykScanVulnerabilities</code>
Note: that if this stage only runs if the SNYK_AUTHENTICATION_CODE is found as environment variable. This variable needs to be defined as environment variable in the deployment configuration of your project jenkins.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_stage_start_openshift_build"><a class="anchor" href="#_stage_start_openshift_build"></a>Stage Start OpenShift Build</h3>
<div class="paragraph">
<p>stageStartOpenshiftBuild triggers the BuildConfig related to the repository
being built.</p>
</div>
<div class="paragraph">
<p>stageStartOpenshiftBuild takes two optional params
(a) the first one, named "buildArgs", which is a map allowing to customise the image build step in OpenShift.
For example:
stageStartOpenshiftBuild(context, ["myArg":"val"])</p>
</div>
<div class="paragraph">
<p>(b) the second one, named "imageLabels", which is a map allowing to customise the image label generation.
For example:
stageStartOpenshiftBuild(context, [ : ], ["myImageLabel":"valLabel"]). This will end up as label prefixed with 'ext.'</p>
</div>
</div>
<div class="sect2">
<h3 id="_stage_scan_for_sonarqube"><a class="anchor" href="#_stage_scan_for_sonarqube"></a>Stage Scan For SonarQube</h3>
<div class="paragraph">
<p>The "SonarQube Analysis" stage scans your source code and reports findings to
SonarQube. The configuration of the scan happens via the
"sonar-project.properties" file in the repository being built.</p>
</div>
<div class="paragraph">
<p>In debug mode, the sonar-scanner binary is started with the "-X" flag.</p>
</div>
<div class="paragraph">
<p>If no "sonar.projectVersion" is specified in "sonar-project.properties", it is
set to the shortened Git SHA.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development"><a class="anchor" href="#_development"></a>Development</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Try to write tests.</p>
</li>
<li>
<p>See if you can split things up into classes.</p>
</li>
<li>
<p>Keep in mind that you need to access e.g. <code>sh</code> via <code>script.sh</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_background"><a class="anchor" href="#_background"></a>Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The implementation is largely based on <a href="https://www.relaxdiego.com/2018/02/jenkins-on-jenkins-shared-libraries.html" class="bare">https://www.relaxdiego.com/2018/02/jenkins-on-jenkins-shared-libraries.html</a>. The scripted pipeline syntax was chosen because it is a better fit for a shared library. The declarative pipeline syntax is targeted for newcomers and/or simple pipelines (see <a href="https://jenkins.io/doc/book/pipeline/syntax/#scripted-pipeline" class="bare">https://jenkins.io/doc/book/pipeline/syntax/#scripted-pipeline</a>). If you try to use it e.g. within a Groovy class you&#8217;ll end up with lots of <code>script</code> blocks.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.1.1/tocbot.min.js"></script>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/search.js" id="search-script" data-base-path="../../.." data-page-path="/opendevstack/1.x/jenkins-shared-library/index.html"></script>
<script async src="../../../_/../search-index.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script>
  tocbot.init( {
                  tocSelector: '#article-toc',
                  contentSelector: 'article',
                  headingSelector: 'h2, h3, h4, h5, h6',
                  collapseDepth: 6,
                  positionFixedSelector: '#article-toc',
                  scrollSmooth: false
                } );
  var tocList = document.getElementById( 'article-toc' ).getElementsByClassName( 'toc-list' );
  if ( tocList && tocList.length > 0 && tocList[0].childNodes.length > 0 ) {
    document.getElementById( 'article-toc' ).parentNode.classList.remove( 'hidden' );
  }
</script>
  </body>
</html>
