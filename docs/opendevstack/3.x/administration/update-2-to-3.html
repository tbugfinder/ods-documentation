<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: OpenDevStack</title>
    <link rel="canonical" href="https://www.opendevstack.org/ods-documentation/opendevstack/3.x/administration/update-2-to-3.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.opendevstack.org/ods-documentation">OpenDevStack</a>
        <div class="navbar-item">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="opendevstack" data-version="3.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../getting-started/index.html">OpenDevStack</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../jenkins-shared-library/index.html">Jenkins Shared Library</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins-shared-library/component-pipeline.html">Component Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins-shared-library/orchestration-pipeline.html">Orchestration Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins-shared-library/quickstarter-pipeline.html">Quickstarter Pipeline</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quickstarters/index.html">Quickstarters</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/docker-plain.html">Docker Plain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-gateway-nginx.html">BE Gateway/Nginx</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-golang-plain.html">BE Golang</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-java-springboot.html">BE Java/Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-typescript-express.html">BE TypeScript/Express</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-python-flask.html">BE Python/Flask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-scala-play.html">BE Scala/Play</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-angular.html">FE Angular</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-ionic.html">FE Ionic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-ml-service.html">Data Science Machine Learning Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-jupyter-notebook.html">Data Science Jupyter Notebook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-rshiny.html">Data Science RShiny app</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/e2e-cypress.html">Cypress E2E testing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/e2e-spock-geb.html">Spock, Geb and Unirest E2E testing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/release-manager.html">Release Manager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jenkins agent Images</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jenkins/agent-base.html">Base Image</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jenkins-agents/golang.html">Go</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jenkins-agents/maven.html">Maven</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jenkins-agents/nodejs10-angular.html">Nodejs10 Angular</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jenkins-agents/python.html">Python</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jenkins-agents/scala.html">Scala</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/authoring-quickstarters.html">Authoring Quickstarters</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../provisioning-app/index.html">Provisioning App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../jenkins/index.html">Jenkins</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins/master.html">Jenkins Master</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins/agent-base.html">Jenkins Agent Base</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins/webhook-proxy.html">Webhook Proxy</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../sonarqube/index.html">SonarQube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Update Guides</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../update-guides/3x.html">Migrate to 3.x</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../update-guides/2x.html">Migrate to 2.x</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation.html">Installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Upgrade</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="update-2-to-3.html">2.x to 3.x</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="update-older.html">older</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/configuration.html">Provisioning App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="keycloak.html">Keycloak</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sonarqube/administration.html">SonarQube</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jenkins/administration.html">Jenkins</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Contributing to ODS</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/development.html">Development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/documentation.html">Documentation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/architecture.html">Provisioning App</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenDevStack</span>
    <span class="version">3.x</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenDevStack</span>
      <ul class="versions">
        <li class="version">
          <a href="../../4.x/getting-started/index.html">4.x Preview</a>
        </li>
        <li class="version is-current is-latest">
          <a href="../getting-started/index.html">3.x</a>
        </li>
        <li class="version">
          <a href="../../2.x/getting-started/index.html">2.x</a>
        </li>
        <li class="version">
          <a href="../../1.x/getting-started/index.html">1.x</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../getting-started/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../getting-started/index.html">OpenDevStack</a></li>
    <li>Administration</li>
    <li>Upgrade</li>
    <li><a href="update-2-to-3.html">2.x to 3.x</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">3.x</button>
  <div class="version-menu">
    <a class="version" href="../../4.x/administration/update-2-to-3.html">4.x Preview</a>
    <a class="version is-current" href="update-2-to-3.html">3.x</a>
    <a class="version is-missing" href="../../2.x/getting-started/index.html">2.x</a>
    <a class="version is-missing" href="../../1.x/getting-started/index.html">1.x</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/opendevstack/ods-core/edit/3.x/docs/modules/administration/pages/update-2-to-3.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_new_central_namespace"><a class="anchor" href="#_new_central_namespace"></a>New central namespace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In ODS 2, there was a central namespace <code>cd</code>, alongside 3 namespace dedicated to the provisioning app: <code>prov-cd</code>, <code>prov-dev</code> and <code>prov-test</code>. In ODS 3, there is only one namespace <code>ods</code>, which contains the whole OpenDevStack installation. When updating from ODS 2 to ODS 3, you will need to move the services running in <code>cd</code>, <code>prov-cd</code> and <code>prov-test</code> to <code>ods</code>. In detail:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SonarQube is moving from <code>cd</code> to <code>ods</code></p>
</li>
<li>
<p>Nexus is moving from <code>cd</code> to <code>ods</code></p>
</li>
<li>
<p>Jenkins (Master and Webhook Proxy) is moving from <code>prov-cd</code> to <code>ods</code></p>
</li>
<li>
<p>Provisioning App is moving from <code>prov-test</code> to <code>ods</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Provisioning App will make use of the Jenkins instance in <code>ods</code> to provision new ODS projects.</p>
</div>
<div class="paragraph">
<p>Apart from the instances, also all build configurations and image streams are moving from <code>cd</code> to <code>ods</code>, which means all users need to pull images from the new namespace.</p>
</div>
<div class="paragraph">
<p>With that in mind, we can start the update procedure!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_update_your_opendevstack_repositories"><a class="anchor" href="#_update_your_opendevstack_repositories"></a>Update your OpenDevStack repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Updating repositories means that new refs from repositories under
<code>github.com/opendevstack</code> are pushed into the repositories in your BitBucket
instance.</p>
</div>
<div class="paragraph">
<p>To do so, run the following and select the version you want to install (<code>3.x</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">make sync-repos</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your OpenDevStack installation is based on a custom branch (such as <code>3.acme</code>), then you
need to create a pull request on BitBucket from <code>3.x</code> into that custom branch now.</p>
</div>
<div class="paragraph">
<p>Now that the repositories are updated, you also need to modify the images and the
running instances in OpenShift.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backup"><a class="anchor" href="#_backup"></a>Backup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before proceeding, it is advisable to make a backup of the existing OpenShift
configuration. This can be done easily with Tailor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># Backup CD project
tailor export -n cd &gt; backup_CD.yml

# Backup provision app namespaces
tailor export -n prov-cd &gt; backup_PROV_CD.yml
tailor export -n prov-dev &gt; backup_PROV_DEV.yml
tailor export -n prov-test &gt; backup_PROV_TEST.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the executing user needs to have permissions to access all resources
in the <code>cd</code> namespaces for this to work properly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tailor"><a class="anchor" href="#_tailor"></a>Tailor</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next, update Tailor.
3.x requires Tailor <a href="https://github.com/opendevstack/tailor/releases/tag/v1.2.2">1.2.2</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">make prepare-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>In 2.x, the Jenkins master base image was pulled from the <code>openshift</code> namespace. The agent base image could have been pulled from that namespace as well, or directly from a registry. In 3.x, the master can also be pulled directly from a registry. The advantage of this is that you do not need to worry about the import policy set in the <code>openshift</code> namespace, which can have suprising results (e.g. your base image never updating even though a fix has been released by RedHat). The behaviour is defined by a new configuration parameter, <code>JENKINS_MASTER_BASE_FROM_IMAGE</code>.</p>
</div>
<div class="paragraph">
<p>Further, in 2.x you had to pick (via <code>JENKINS_AGENT_BASE_IMAGE</code>) whether you wanted to use <code>Dockerfile.centos7</code> or <code>Dockerfile.rhel7</code>. However, both files contained the same instructions. Therefore, those were combined into a single <code>Dockerfile</code> and you only need to choose which base image to use via <code>JENKINS_AGENT_BASE_FROM_IMAGE</code> (like before).</p>
</div>
<div class="paragraph">
<p>After you have updated/added/removed all parameters with your desired values,
commit and push the result.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_openshift_resources"><a class="anchor" href="#_openshift_resources"></a>OpenShift resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next you need to update all OpenShift resources (such as DC or BC). Review the diff produced by Tailor carefully before applying changes.</p>
</div>
<div class="paragraph">
<p>In <code>ods-core</code>, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">make install-ods-project
make install-jenkins
make install-nexus
make install-doc-gen</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>ods-quickstarters</code>, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">make install-jenkins-agent</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_provisioning_app_changes"><a class="anchor" href="#_provisioning_app_changes"></a>Provisioning App changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With <strong>OpenDevStack</strong> version 3.x the <em>"production"</em> instance of the Provisioning App is moving from the <code>prov-test</code> to the <code>ods</code> namespace.
The following steps describe how to perform the change:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Backup Data to a local directory<br>
<code>oc cp prov-test/&lt;ods-provisioning-pod-name&gt;:/opt/provision/history/ ./history</code></p>
</li>
<li>
<p>Backup Data to a local directory<br>
<code>oc cp prov-test/&lt;ods-provisioning-pod-name&gt;:/opt/provision/history/ ./history</code></p>
</li>
<li>
<p>Install the Provisioning App in the <code>ods</code> namespace<br>
<code>make install-provisioning-app</code></p>
</li>
<li>
<p>Copy backed up data to new instance<br>
<code>oc cp ./history ods/&lt;ods-provisioning-pod-name&gt;:/opt/provision</code></p>
</li>
<li>
<p>Depending on your use of the Provisioning App you can either:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>delete all <code>prov-*</code> namespaces if you are only interested in running a <em>"production"</em> instance.</p>
</li>
<li>
<p>only delete the data under <code>/opt/provision/history</code> in the <code>prov-test</code> namespace if you want to keep your setup.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sonarqube_changes"><a class="anchor" href="#_sonarqube_changes"></a>SonarQube changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With <strong>OpenDevStack</strong> version 3.x SonarQube is moving from the <code>cd</code> namespace to the <code>ods</code> namespace.
The following outlines the procedure for SonarQube:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the SonarQube build resources in <code>ods</code> using <code>make apply-sonarqube-build</code></p>
</li>
<li>
<p>Start build of SonarQube image in <code>ods</code> using <code>make start-sonarqube-build</code></p>
</li>
<li>
<p>Scale down the SonarQube pod in <code>cd</code></p>
</li>
<li>
<p>Create a backup of the old data using <code>make ODS_NAMESPACE=cd backup-sonarqube</code></p>
</li>
<li>
<p>Create the SonarQube deploy resources in <code>ods</code> using <code>make apply-sonarqube-deploy</code></p>
</li>
<li>
<p>Scale down the SonarQube pod in <code>ods</code></p>
</li>
<li>
<p>Upload backup to new Postgres pod: <code>oc -n ods cp sonarqube/sonarqube.sql &lt;sonarqube-postgresql-pod&gt;:/var/lib/pgsql/</code></p>
</li>
<li>
<p>Start a bash in the Postgres pod: <code>oc rsh -n ods pod/&lt;sonarqube-postgresql-pod&gt; bash</code> and start a <code>psql</code> session.</p>
</li>
<li>
<p>Drop the <code>sonarqube</code> database (<code>DROP DATABASE sonarqube</code>) and create a new, empty one (<code>CREATE DATABASE sonarqube OWNER sonarqube</code>). Then quit from <code>psql</code>.</p>
</li>
<li>
<p>Import the backup with <code>psql sonarqube &lt; sonarqube.sql</code></p>
</li>
<li>
<p>Scale up the SonarQube pod in <code>ods</code>.</p>
</li>
<li>
<p>At this stage, the new SonarQube instance is fully functional, but the Elasticsearch index is not correct and therefore no projects show on the dashboard initially. To fix this, log into SonarQube with an admin user and go to "Administration &gt; System". Then, start a bash in the SonarQube pod: <code>oc rsh -n ods pod/&lt;sonarqube-pod&gt; bash</code> and remove <code>/opt/sonarqube/data/es6</code>. Afterwards, restart the server from the UI (there&#8217;s a button on the "Administration &gt; System" page). Booting will take some time (depending on the amount of data to process) as a full re-index is performed.</p>
</li>
<li>
<p>Call <code>make configure-sonarqube</code> to verify the new installation is correctly configured.</p>
</li>
<li>
<p>Now delete the old SonarQube route in <code>cd</code>.</p>
</li>
<li>
<p>Create a new route in <code>ods</code> with the same host as the old route so that projects using the old URL don&#8217;t break.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secure_route_removal"><a class="anchor" href="#_secure_route_removal"></a>Secure route removal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Checking for secure routes has been removed from the core, but is still available at <a href="https://github.com/BIX-Digital/ods-contrib" class="bare">https://github.com/BIX-Digital/ods-contrib</a>.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.1.1/tocbot.min.js"></script>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/search.js" id="search-script" data-base-path="../../.." data-page-path="/opendevstack/3.x/administration/update-2-to-3.html"></script>
<script async src="../../../_/../search-index.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script>
  tocbot.init( {
                  tocSelector: '#article-toc',
                  contentSelector: 'article',
                  headingSelector: 'h2, h3, h4, h5, h6',
                  collapseDepth: 6,
                  positionFixedSelector: '#article-toc',
                  scrollSmooth: false
                } );
  var tocList = document.getElementById( 'article-toc' ).getElementsByClassName( 'toc-list' );
  if ( tocList && tocList.length > 0 && tocList[0].childNodes.length > 0 ) {
    document.getElementById( 'article-toc' ).parentNode.classList.remove( 'hidden' );
  }
</script>
  </body>
</html>
