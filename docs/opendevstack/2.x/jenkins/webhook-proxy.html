<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins Webhook Proxy :: OpenDevStack</title>
    <link rel="canonical" href="https://www.opendevstack.org/ods-documentation/opendevstack/3.x/jenkins/webhook-proxy.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.opendevstack.org/ods-documentation">OpenDevStack</a>
        <div class="navbar-item">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="opendevstack" data-version="2.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../getting-started/index.html">OpenDevStack</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../jenkins-shared-library/index.html">Jenkins Shared Library</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quickstarters/index.html">Quickstarters</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/docker-plain.html">BE Docker Plain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-golang-plain.html">BE Golang</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-java-springboot.html">BE Java / Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-typescript-express.html">BE Node Express</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-python-flask.html">BE Python Flask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/be-scala-akka.html">BE Scala Akka</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-angular.html">FE Angular</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-ionic.html">FE Ionic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-react.html">FE React</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/fe-vue.html">FE Vue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-ml-service.html">Data Science Machine Learning Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-jupyter-notebook.html">Data Science Jupyter Notebook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/ds-rshiny.html">Data Science RShiny app</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/airflow-cluster.html">Airflow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstarters/e2e-cypress.html">Cypress E2E testing Quickstarters</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../provisioning-app/index.html">Provisioning App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/configuration.html">Configuration Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/architecture.html">Internal Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/faq.html">FAQ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../provisioning-app/upgrade_notes.html">Upgrade Notes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../local-installation.html">Local Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sysenv-requirements.html">System and Environment Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../infrastructure-setup.html">Infrastructure Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Jenkins</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="webhook-proxy.html">Webhook Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="slave-base.html">Jenkins Slave Base Image</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../sonarqube/index.html">SonarQube</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenDevStack</span>
    <span class="version">2.x</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenDevStack</span>
      <ul class="versions">
        <li class="version">
          <a href="../../4.x/getting-started/index.html">4.x Preview</a>
        </li>
        <li class="version is-latest">
          <a href="../../3.x/getting-started/index.html">3.x</a>
        </li>
        <li class="version is-current">
          <a href="../getting-started/index.html">2.x</a>
        </li>
        <li class="version">
          <a href="../../1.x/getting-started/index.html">1.x</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../3.x/getting-started/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../getting-started/index.html">OpenDevStack</a></li>
    <li><a href="index.html">Jenkins</a></li>
    <li><a href="webhook-proxy.html">Webhook Proxy</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">2.x</button>
  <div class="version-menu">
    <a class="version" href="../../4.x/jenkins/webhook-proxy.html">4.x Preview</a>
    <a class="version" href="../../3.x/jenkins/webhook-proxy.html">3.x</a>
    <a class="version is-current" href="webhook-proxy.html">2.x</a>
    <a class="version" href="../../1.x/jenkins/webhook-proxy.html">1.x</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/opendevstack/ods-core/edit/2.x/docs/modules/jenkins/pages/webhook-proxy.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Jenkins Webhook Proxy</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The webhook proxy service allows to trigger Jenkins pipelines. Further, it
automatically creates pipelines that do not exist yet and can delete pipelines
that are no longer needed.</p>
</div>
<div class="paragraph">
<p>One instance of the webhook proxy runs in every <code>&lt;project&gt;-cd</code> namespace next to
the Jenkins instance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_endpoints"><a class="anchor" href="#_endpoints"></a>Endpoints</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_post"><a class="anchor" href="#_post"></a><code>POST /</code></h3>
<div class="paragraph">
<p>Accepts webhooks from BitBucket and forwards them to the corresponding Jenkins
pipeline (which is determined based on the component param and the branch name).
If there is no corresponding pipeline yet, it will be created on the fly (by
creating a <code>BuildConfig</code> in OpenShift which is synced to Jenkins via the
OpenShift plugin). Once a branch is deleted or a pull request declined/merged,
the corresponding Jenkins pipeline is deleted.</p>
</div>
</div>
<div class="sect2">
<h3 id="_post_build"><a class="anchor" href="#_post_build"></a><code>POST /build</code></h3>
<div class="paragraph">
<p>Accepts a payload of the following form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "branch": "foo",
    "repository": "repository",
    "env": [
       {
          "name": "FOO_BAR",
          "value": "baz"
       }
    ],
    "project": "bar"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Important</strong>: In order to avoid conflicts between pipelines created/triggered
via BitBucket and pipelines created/triggered via <code>/build</code>, most likely you&#8217;d
want to pass a component name to <code>/build</code>, like so: <code>/build?component=foo</code>, see
the next section.</p>
</div>
<div class="paragraph">
<p>Also note that the <code>project</code> field is optional, and restricted to the project of the webhook proxy and <code>opendevstack</code> by default (but can be customized via <code>ALLOWED_EXTERNAL_PROJECTS</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_parameters"><a class="anchor" href="#_parameters"></a>Parameters</h3>
<div class="paragraph">
<p>Both <code>/</code> and <code>/build</code> accept the following query parameters. They are offered
as query parameters only because otherwise they could not be adjusted for
BitBucket webhooks.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jenkinsfile_path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the <code>Jenkinsfile</code>. By default, the <code>Jenkinsfile</code> is assumed to be in the root of the repository, therefore this value defaults to simply <code>Jenkinsfile</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">component</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The component part of the pipeline name. If not given, the pipeline name is created from the repository and the branch.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_responses"><a class="anchor" href="#_responses"></a>Responses</h3>
<div class="paragraph">
<p>All endpoints return the <code>BuildConfig</code> response as-is from OpenShift, see <a href="https://docs.openshift.com/container-platform/3.11/rest_api/apis-build.openshift.io/v1.BuildConfig.html#object-schema" class="bare">https://docs.openshift.com/container-platform/3.11/rest_api/apis-build.openshift.io/v1.BuildConfig.html#object-schema</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_a_webhook_in_bitbucket"><a class="anchor" href="#_adding_a_webhook_in_bitbucket"></a>Adding a webhook in BitBucket</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The provisioning app sets up one webhook per repository by default. It is
possible to create webhooks manually as well, e.g. to add more than one
webhook (likely differentiated by the <code>component</code> param then).</p>
</div>
<div class="paragraph">
<p>To manually create a webhook, go to "Repository Settings &gt; Webhooks" and click on
"Create webhook". Fill in the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name: <code>Jenkins</code> (or similar, value is only serves as a description)</p>
</li>
<li>
<p>URL: route to the webhook proxy instance, followed by the <code>trigger_secret</code>, e.g. <code><a href="https://webhook-proxy-foo-cd.example.com?trigger_secret=s3cr3t" class="bare">https://webhook-proxy-foo-cd.example.com?trigger_secret=s3cr3t</a></code>. The secret can be retrieved in the OpenShift console in your <code>*-cd</code> namespace (in this example <code>foo-cd</code>) under "Resources &gt; Secrets &gt; webhook-proxy".</p>
</li>
<li>
<p>Secret: leave blank</p>
</li>
<li>
<p>Under "Repository events", select <code>Push</code>. Under "Pull request events", select <code>Merged</code> and <code>Declined</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now you can verify by clicking "Test connection". Afterwards, save your changes. The next pushed commit should automatically send a request to the webhook proxy and start a pipeline in Jenkins.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customizing_the_behaviour_of_the_webhook_proxy"><a class="anchor" href="#_customizing_the_behaviour_of_the_webhook_proxy"></a>Customizing the behaviour of the webhook proxy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following environment variables are read by the proxy:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PROTECTED_BRANCHES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma-separated list of branches which pipelines should not be cleaned up. Use either exact branch names, branch prefixes (e.g. <code>feature/</code>) or <code>*</code> for all branches. Defaults to: <code>master,develop,production,staging,release/</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPENSHIFT_API_HOST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defaults to <code>openshift.default.svc.cluster.local</code>. Usually does not need to be modified.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REPO_BASE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The base URL of the repository (e.g. your BitBucket host). This variable is set by the template and usually does not need to be modified.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIGGER_SECRET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The secret which protects the pipeline to be executed from outside. This variable is set by the template and usually does not need to be modified.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALLOWED_EXTERNAL_PROJECTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma-separated list of external projects which the Webhook Proxy can deal with. By default, this is just the <code>opendevstack</code> project.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_development"><a class="anchor" href="#_development"></a>Development</h2>
<div class="sectionbody">
<div class="paragraph">
<p>See the <code>Makefile</code> targets.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.1.1/tocbot.min.js"></script>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/search.js" id="search-script" data-base-path="../../.." data-page-path="/opendevstack/2.x/jenkins/webhook-proxy.html"></script>
<script async src="../../../_/../search-index.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script>
  tocbot.init( {
                  tocSelector: '#article-toc',
                  contentSelector: 'article',
                  headingSelector: 'h2, h3, h4, h5, h6',
                  collapseDepth: 6,
                  positionFixedSelector: '#article-toc',
                  scrollSmooth: false
                } );
  var tocList = document.getElementById( 'article-toc' ).getElementsByClassName( 'toc-list' );
  if ( tocList && tocList.length > 0 && tocList[0].childNodes.length > 0 ) {
    document.getElementById( 'article-toc' ).parentNode.classList.remove( 'hidden' );
  }
</script>
  </body>
</html>
